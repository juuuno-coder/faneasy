# 서브도메인 멀티테넌시의 구축

_(부제: 2025-12-26, 서브도메인 기반 라우팅과 관리자 인증 체계를 수립하다)_

## 발단: 다중 도메인 서비스의 기틀

레오는 인플루언서와 팬들로 구성된 계층적 서비스 구조를 제안했다. 각 인플루언서가 개별 서브도메인을 소유하고, 그 아래에 여러 팬 페이지가 공존하는 멀티테넌시 환경이 목표였다. 이를 위해 로컬 환경에서도 서브도메인을 실시간으로 처리할 수 있는 기술적 장치가 필요했다.

## 전개: 인증과 상태 관리의 정의

안티그래비티는 `Zustand`를 이용해 인증 상태와 페이지 데이터를 관리하는 글로벌 스토어를 구축했다. 또한 `mock` 로그인 API와 JWT 기반의 보안 체계를 설계하여 인플루언서와 팬의 권한을 분리했다. 관리자 대시보드의 초기 배치를 통해 실제 운영 가능한 플랫폼의 외형을 갖추기 시작했다.

## 위기: 포트 번호와 미들웨어의 충돌

초기 설정했던 3500번 포트의 접속 문제로 인해 3600번 포트로 긴급 마이그레이션이 진행되었다. 포트 변경 후, Next.js 미들웨어가 Host 헤더의 포트 번호를 처리하지 못해 404 에러를 내뱉는 현상이 발생했다. 서브도메인 인식 로직이 포트 번호라는 변수를 계산에 넣지 못해 발생한 구조적 결함이었다.

## 절정: 정교한 호스트 파싱 로직의 도입

안티그래비티는 `middleware.ts` 내의 호스트 추출 로직을 전면 수정했다. `split` 함수를 체이닝하여 도메인 이름에서 불필요한 포트 번호를 분리해내는 정규화 과정을 적용했다. 레오와 함께 수정한 미들웨어는 마침내 `kkang.localhost:3600`과 같은 복합 주소를 정확히 인식하여 해당 사이트의 컨텐츠로 연결시켰다.

## 결말: 플랫폼 확장을 위한 검증 완료

서브도메인 기반의 라우팅이 정상화됨에 따라 팬이지 플랫폼은 대규모 서비스 확장을 위한 기술적 검증을 마쳤다. 인플루언서와 팬이라는 서로 다른 이해관계자가 하나의 시스템 위에서 안전하게 각자의 데이터를 관리할 수 있게 된 것이다. 협업 초기 발생한 네트워크 환경 변수를 성공적으로 극복하며 플랫폼의 신뢰성을 확보했다.

---

### 🛠 기술적 각주 (Technical Summary)

- **수정된 파일 (Modified Files)**:
  - `middleware.ts`: 포트 번호가 포함된 Host 헤더에서 순수 호스트네임을 추출하는 파싱 로직 구현.
  - `package.json`: 개발 포트 명시적 변경 (3600).
  - `lib/store.ts`: Zustand 기반의 다중 사이트 상태 관리 체계 구축.
- **주요 기술 (Key Tech Stack)**:
  - **Next.js Middleware**: URL 리라이트를 이용한 서브도메인 테넌시 구현.
  - **Zustand**: 클라이언트 사이드 전역 상태 관리 및 인증 정보 보존.
- **핵심 기능 (Key Features)**:
  - **Subdomain-to-Path Rewriting**: `[subdomain].domain.com` 요청을 `/sites/[subdomain]`으로 자동 매핑.
  - **Role-based Access Control**: 계층적 유저 권한에 따른 관리자 페이지 접근 제어.
